name: Re-Deploy(Without Build) to Digital Ocean 🛫

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Run on workflow_dispatch OR push with [re-deploy]
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && contains(github.event.head_commit.message, '[re-deploy]'))
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run SSH commands on DigitalOcean
        id: redeploy_step
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "✅ Connected to DigitalOcean!"
            cd BetweenUsServer/
            echo "♻️ Restarting containers (without rebuild)..."
            docker compose down
            docker compose up -d
            echo "✅ Re-Deploy Finished"

            echo "📊 Gathering System Info..."
            echo "---- Disk Usage ----"
            df -h
            echo "---- Memory Usage ----"
            free -m
            echo "---- CPU Load ----"
            uptime
            echo "---- Top Processes ----"
            ps aux --sort=-%mem | head -n 10
            echo "---- Docker Status ----"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            echo "---- Last 20 Logs ----"
            docker compose logs --tail=20

            # Save report to a file so GitHub can use it later
            echo "📢 Re-Deploy Report" > redeploy_report.txt
            echo "---------------------" >> redeploy_report.txt
            echo "Repository: $GITHUB_REPOSITORY" >> redeploy_report.txt
            echo "Commit: $GITHUB_SHA" >> redeploy_report.txt
            echo "Commit Message: ${{ github.event.head_commit.message }}" >> redeploy_report.txt
            echo "Triggered by: $GITHUB_ACTOR" >> redeploy_report.txt
            echo "Deploy Type: re-deploy (without build)" >> redeploy_report.txt
            echo "---------------------" >> redeploy_report.txt
            echo "✅ Re-Deployment Completed!" >> redeploy_report.txt

      - name: Upload Deployment Report
        uses: actions/upload-artifact@v4
        with:
          name: redeploy_report
          path: redeploy_report.txt

      - name: Send Report to Signal
        run: |
          REPORT=$(cat redeploy_report.txt | sed ':a;N;$!ba;s/\n/ %0A /g')
          curl -s "https://signal.callmebot.com/signal/send.php?${{ secrets.CALL_ME_API_PARAMS }}&text=${REPORT}"
