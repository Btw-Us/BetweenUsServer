name: Re-Deploy(Without Build) to Digital Ocean üõ´
on:
  workflow_dispatch:
  push:
    branches: [ "master" ]
jobs:
  deploy:
    runs-on: ubuntu-latest
    # Run on workflow_dispatch OR push with [re-deploy]
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && contains(github.event.head_commit.message, '[re-deploy]'))
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Re-Deploy and Generate Report
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            echo "‚úÖ Connected to DigitalOcean!"
            cd BetweenUsServer/
            echo "‚ôªÔ∏è Restarting containers (without rebuild)..."
            docker compose down
            docker compose up -d
            echo "‚úÖ Re-Deploy Finished"
            echo "üìä Gathering System Info..."
  notify:
    runs-on: ubuntu-latest
    needs: deploy
    if: always()   # ‚úÖ Always run, even if skipped/failed
    steps:
      - name: Send Signal Notification
        run: |
          EXEC_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          if [ "${{ needs.deploy.result }}" = "skipped" ]; then
            MESSAGE="‚ö†Ô∏è Deployment Skipped%0A‚è∞ Time: $EXEC_TIME"
          elif [ "${{ needs.deploy.result }}" = "failure" ]; then
            MESSAGE="‚ùå Deployment Failed%0A‚è∞ Time: $EXEC_TIME"
          elif [ "${{ needs.deploy.result }}" = "success" ] && [ "${{ github.event_name }}" = "push" ]; then
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            MESSAGE="üöÄ Deployment Completed%0Aüìù Commit: $COMMIT_MSG%0A‚è∞ Time: $EXEC_TIME"
          elif [ "${{ needs.deploy.result }}" = "success" ] && [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            MESSAGE="üöÄ Deployment Completed (Manual Trigger)%0A‚è∞ Time: $EXEC_TIME"
          else
            MESSAGE="‚ùì Unknown deployment status: ${{ needs.deploy.result }}%0A‚è∞ Time: $EXEC_TIME"
          fi
          curl -s "https://signal.callmebot.com/signal/send.php?${{ secrets.CALL_ME_API_PARAMS }}&text=$MESSAGE"
